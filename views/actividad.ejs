<%- include ('Plantilla/Inicio') %>
<script>
  const SEED = <%- JSON.stringify(typeof seed !== 'undefined' ? seed : {items:[], total:0, page:1, perPage:20}) %>;
</script>

<!-- === ACTIVIDAD: KPIs + Filtros + Timeline === -->
<section id="actividad" class="space-y-6">

  <!-- Encabezado y acciones -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h2 class="text-xl md:text-2xl font-semibold text-gray-900">Actividad reciente</h2>
      <p class="text-sm text-gray-500">Eventos de acceso, aperturas manuales e incidencias del sistema.</p>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnExport" class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm text-gray-700 hover:bg-gray-50">Exportar CSV</button>
      <button id="btnRefresh" class="px-3 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">Actualizar</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
    <div class="bg-white rounded-xl border border-gray-200 p-4">
      <div class="text-xs text-gray-500">Eventos (24h)</div>
      <div id="kpiTotal" class="mt-1 text-2xl font-semibold text-gray-900">0</div>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4">
      <div class="text-xs text-gray-500">Correctos</div>
      <div id="kpiOk" class="mt-1 text-2xl font-semibold text-gray-900">0</div>
      <div id="kpiOkDelta" class="text-xs text-green-600 mt-1">‚Äî</div>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4">
      <div class="text-xs text-gray-500">Denegados</div>
      <div id="kpiFail" class="mt-1 text-2xl font-semibold text-gray-900">0</div>
      <div id="kpiFailTop" class="text-xs text-gray-500 mt-1">‚Äî</div>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4">
      <div class="text-xs text-gray-500">Aperturas manuales</div>
      <div id="kpiManual" class="mt-1 text-2xl font-semibold text-gray-900">0</div>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4">
      <div class="text-xs text-gray-500">Prom. tiempo verificaci√≥n</div>
      <div id="kpiLatency" class="mt-1 text-2xl font-semibold text-gray-900">‚Äî</div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="bg-white rounded-2xl border border-gray-200 p-4">
    <form id="filters" class="grid grid-cols-1 md:grid-cols-12 gap-3">
      <label class="md:col-span-4">
        <span class="sr-only">Buscar</span>
        <input id="fQ" type="text" placeholder="Buscar: nombre, correo, ID, motivo‚Ä¶"
               class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600 focus:border-blue-600">
      </label>
      <label class="md:col-span-2">
        <span class="sr-only">Rango</span>
        <select id="fRange" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600 focus:border-blue-600">
          <option value="hoy">Hoy</option>
          <option value="24h">√öltimas 24h</option>
          <option value="semana">Esta semana</option>
          <option value="mes">Este mes</option>
        </select>
      </label>
      <label class="md:col-span-2">
        <span class="sr-only">Evento</span>
        <select id="fTipo" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600 focus:border-blue-600">
          <option value="">Evento (todos)</option>
          <option value="entrada">Entrada</option>
          <option value="salida">Salida</option>
          <option value="manual">Apertura manual</option>
          <option value="denegado">Acceso denegado</option>
        </select>
      </label>
      <label class="md:col-span-2">
        <span class="sr-only">Estado</span>
        <select id="fEstado" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600 focus:border-blue-600">
          <option value="">Estado (todos)</option>
          <option value="ok">Correcto</option>
          <option value="fail">Denegado</option>
        </select>
      </label>
      <label class="md:col-span-2">
        <span class="sr-only">Dispositivo</span>
        <select id="fDevice" class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-600 focus:border-blue-600">
          <option value="">Dispositivo (todos)</option>
        </select>
      </label>
      <div class="md:col-span-12 flex items-center gap-2">
        <button id="btnFilter" class="px-3 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">Aplicar</button>
        <button id="btnClear" type="button" class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm text-gray-700 hover:bg-gray-50">Limpiar</button>
      </div>
    </form>
  </div>

  <!-- Solo Timeline -->
  <div class="grid grid-cols-1">
    <div class="bg-white rounded-2xl border border-gray-200 p-4">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold text-gray-900">Eventos</h3>
        <span id="tlCount" class="text-sm text-gray-500">0 eventos</span>
      </div>
      <ol id="timeline" class="relative ml-4 border-l border-gray-200"></ol>
    </div>
  </div>

  <!-- Modal de Detalles -->
  <dialog id="dlg" class="rounded-2xl backdrop:bg-black/40 w-full max-w-2xl p-0">
    <div class="bg-white rounded-2xl overflow-hidden">
      <header class="px-5 py-4 border-b border-gray-200 flex items-center justify-between">
        <h4 id="dlgTitle" class="text-lg font-semibold text-gray-900">Detalle del evento</h4>
        <button id="dlgClose" class="p-1.5 rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50">‚úï</button>
      </header>
      <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
        <div class="space-y-2">
          <div><span class="text-gray-500">Empleado:</span> <span id="dEmpleado" class="font-medium text-gray-900">‚Äî</span></div>
          <div><span class="text-gray-500">Puesto:</span> <span id="dPuesto" class="text-gray-900">‚Äî</span></div>
          <div><span class="text-gray-500">Evento:</span> <span id="dEvento" class="text-gray-900">‚Äî</span></div>
          <div><span class="text-gray-500">Resultado:</span> <span id="dEstado" class="text-gray-900">‚Äî</span></div>
          <div><span class="text-gray-500">Motivo:</span> <span id="dMotivo" class="text-gray-900">‚Äî</span></div>
        </div>
        <div class="space-y-2">
          <div><span class="text-gray-500">Fecha/Hora:</span> <span id="dFecha" class="text-gray-900">‚Äî</span></div>
          <div><span class="text-gray-500">Dispositivo:</span> <span id="dDevice" class="text-gray-900">‚Äî</span></div>
          <div><span class="text-gray-500">M√©todo:</span> <span id="dMetodo" class="text-gray-900">‚Äî</span></div>
          <div><span class="text-gray-500">Ubicaci√≥n:</span> <span id="dUbicacion" class="text-gray-900">‚Äî</span></div>
          <div><span class="text-gray-500">Audit ID:</span> <span id="dAudit" class="text-gray-900">‚Äî</span></div>
        </div>
      </div>
      <footer class="px-5 py-4 border-t border-gray-200 flex items-center justify-end gap-2">
        <button id="dlgOk" class="px-3 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">Aceptar</button>
      </footer>
    </div>
  </dialog>

  <!-- Di√°logo Exportar CSV -->
  <dialog id="dlgExport" class="rounded-2xl backdrop:bg-black/40 w-full max-w-md p-0">
    <form method="dialog" class="bg-white rounded-2xl overflow-hidden">
      <header class="px-5 py-4 border-b border-gray-200">
        <h4 class="text-lg font-semibold text-gray-900">Exportar CSV</h4>
        <p class="text-sm text-gray-500">Elige el rango para exportar.</p>
      </header>
      <div class="p-5 space-y-4 text-sm">
        <label class="flex items-center gap-2">
          <input type="radio" name="expMode" value="vista" checked>
          <span>Usar el select ‚ÄúRango‚Äù actual</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="expMode" value="semana">
          <span>Semana actual (Lun‚ÄìDom)</span>
        </label>
        <label class="flex items-start gap-2">
          <input type="radio" name="expMode" value="fechas">
          <span class="w-full">
            Por fechas
            <div class="grid grid-cols-2 gap-2 mt-2">
              <input id="expDesde" type="date" class="w-full rounded-lg border border-gray-200 px-3 py-2">
              <input id="expHasta" type="date" class="w-full rounded-lg border border-gray-200 px-3 py-2">
            </div>
            <small class="text-gray-500">Incluye ambos d√≠as (00:00‚Äì23:59).</small>
          </span>
        </label>
      </div>
      <footer class="px-5 py-4 border-t border-gray-200 flex items-center justify-end gap-2">
        <button type="button" id="expCancel" class="px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm text-gray-700 hover:bg-gray-50">Cancelar</button>
        <button type="button" id="expOk" class="px-3 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">Exportar</button>
      </footer>
    </form>
  </dialog>
</section>



<script>
/* ======= Estado ======= */
let DATA = SEED.items || [];
let TOTAL = SEED.total || 0;
let page  = SEED.page  || 1;
let size  = SEED.perPage || 20;

let q = '', range = '24h', tipo = '', estado = '', device = '';

/* ======= Utils ======= */
const $  = (q) => document.querySelector(q);
const $$ = (q) => document.querySelectorAll(q);

const fmtBadge = (ok) =>
  `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${ok ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200'}">
     <span class="w-1.5 h-1.5 rounded-full ${ok ? 'bg-green-600' : 'bg-red-600'} mr-2"></span>${ok ? 'Correcto' : 'Denegado'}
   </span>`;

const iconFor = (ev) => {
  if (ev === 'entrada') return '‚û°Ô∏è';
  if (ev === 'salida')  return '‚¨ÖÔ∏è';
  if (ev === 'manual')  return 'üîì';
  return '‚õî';
};

/* ======= Render KPIs ======= */
function renderKpis(rows) {
  $('#kpiTotal').textContent = rows.length;
  const ok     = rows.filter(r => r.estado === 'ok').length;
  const fail   = rows.filter(r => r.estado === 'fail').length;
  const manual = rows.filter(r => r.evento === 'manual').length;

  $('#kpiOk').textContent = ok;
  $('#kpiFail').textContent = fail;
  $('#kpiManual').textContent = manual;

  $('#kpiOkDelta').textContent = ok ? `Tasa √©xito ${(ok/Math.max(1,rows.length)*100).toFixed(0)}%` : '‚Äî';
  const topReason = rows.filter(r=>r.estado==='fail').reduce((acc,r)=>{
    acc[r.motivo||'‚Äî']= (acc[r.motivo||'‚Äî']||0)+1; return acc;
  },{});
  const top = Object.entries(topReason).sort((a,b)=>b[1]-a[1])[0];
  $('#kpiFailTop').textContent = top ? `Motivo com√∫n: ${top[0]}` : '‚Äî';
  $('#kpiLatency').textContent = '‚Äî';
}

/* ======= Render Timeline ======= */
function renderTimeline(rows) {
  const c = $('#timeline'); c.innerHTML = '';
  rows.slice(0, 12).forEach(r => {
    const li = document.createElement('li');
    li.className = 'mb-6 ml-3';
    li.innerHTML = `
      <span class="absolute -left-1.5 mt-1 w-3 h-3 rounded-full ${r.estado==='ok'?'bg-green-500':'bg-red-500'}"></span>
      <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
        <div class="flex items-start justify-between">
          <div class="flex items-center">
            <div class="ml-3">
              <div class="font-medium text-gray-900">${r.empleado}</div>
              <div class="text-xs text-gray-500">${r.puesto || ''}</div>
            </div>
          </div>
          <div class="text-right">
            <div class="text-sm text-gray-900">${iconFor(r.evento)} ${r.evento.charAt(0).toUpperCase()+r.evento.slice(1)}</div>
            <div class="text-xs text-gray-500">${r.fecha}</div>
          </div>
        </div>
        <dl class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4 text-xs">
          <div><dt class="text-gray-500">Dispositivo</dt><dd class="text-gray-900 font-medium">${r.deviceName} (${r.deviceId})</dd></div>
          <div><dt class="text-gray-500">M√©todo</dt><dd class="text-gray-900">${r.metodo}</dd></div>
          <div><dt class="text-gray-500">Resultado</dt><dd>${fmtBadge(r.estado==='ok')}</dd></div>
          <div><dt class="text-gray-500">Motivo</dt><dd class="text-gray-900">${r.motivo || '‚Äî'}</dd></div>
          <div><dt class="text-gray-500">Ubicaci√≥n</dt><dd class="text-gray-900">${r.ubicacion || '‚Äî'}</dd></div>
          <div><dt class="text-gray-500">Operador</dt><dd class="text-gray-900">${r.operador || 'Sistema'}</dd></div>
          <div><dt class="text-gray-500">Audit ID</dt><dd class="text-gray-900">${r.auditId || '‚Äî'}</dd></div>
        </dl>
        <div class="mt-4 flex items-center gap-2">
          <button data-id="${r.id ?? r.id_evento}" 
        class="btn-detalle px-3 py-2 rounded-lg border border-gray-200 bg-white text-xs text-gray-700 hover:bg-gray-50">
  Ver detalle
</button>
        </div>
      </div>
    `;
    c.appendChild(li);
  });
  $('#tlCount').textContent = `${Math.min(rows.length,12)} de ${rows.length} eventos`;
}

/* ======= Modal Detalle ======= */
function openDetail(r) {
  if (!r) return;
  $('#dEmpleado').textContent = r.empleado;
  $('#dPuesto').textContent   = r.puesto || '‚Äî';
  $('#dEvento').textContent   = r.evento;
  $('#dEstado').innerHTML     = r.estado==='ok' ? 'Correcto' : 'Denegado';
  $('#dMotivo').textContent   = r.motivo || '‚Äî';
  $('#dFecha').textContent    = r.fecha;
  $('#dDevice').textContent   = `${r.deviceName} (${r.deviceId})`;
  $('#dMetodo').textContent   = r.metodo || '‚Äî';
  $('#dUbicacion').textContent= r.ubicacion || '‚Äî';
  $('#dAudit').textContent    = r.auditId || '‚Äî';
  $('#dlg').showModal();
}
$('#dlgClose')?.addEventListener('click', ()=> $('#dlg').close());
$('#dlgOk')?.addEventListener('click',   ()=> $('#dlg').close());

/* ======= Carga desde backend ======= */
async function loadData() {
  const params = new URLSearchParams({
    page: String(page),
    perPage: String(size),
    q, range, tipo, estado, device
  });
  const res = await fetch(`/api/actividad?${params.toString()}`, { headers: { 'Accept':'application/json' } });
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || 'Error al cargar datos');
  DATA = json.items || [];
  TOTAL = json.total || 0;
}

async function refresh() {
  try { await loadData(); } catch(e){ console.error(e); }
  renderKpis(DATA);
  renderTimeline(DATA);
}

/* ======= Listeners UI ======= */
$('#btnFilter').addEventListener('click', (e)=>{
  e.preventDefault();
  q = $('#fQ').value.trim();
  range = $('#fRange').value;
  tipo = $('#fTipo').value;
  estado = $('#fEstado').value;
  device = $('#fDevice').value;
  page = 1;
  refresh();
});

$('#btnClear').addEventListener('click', ()=>{
  $('#filters').reset();
  q=''; range='24h'; tipo=''; estado=''; device='';
  page=1; refresh();
});

$('#btnRefresh').addEventListener('click', refresh);

/* ======= Export CSV (con semana/fechas) ======= */
const dlgExport = document.getElementById('dlgExport');
const expOk     = document.getElementById('expOk');
const expCancel = document.getElementById('expCancel');

$('#btnExport').addEventListener('click', () => {
  // Prefill de fechas: por UX, setea semana actual por defecto
  const today = new Date();
  const dow = (today.getDay() + 6) % 7; // 0 = Lunes
  const monday = new Date(today); monday.setDate(today.getDate() - dow);
  const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);
  const toISO = d => d.toISOString().slice(0,10);
  $('#expDesde').value = toISO(monday);
  $('#expHasta').value = toISO(sunday);

  dlgExport.showModal();
});

expCancel?.addEventListener('click', () => dlgExport.close());

expOk?.addEventListener('click', () => {
  const mode = document.querySelector('input[name="expMode"]:checked')?.value || 'vista';

  const params = new URLSearchParams({
    // Reusa filtros actuales
    q, tipo, estado, device
  });

  if (mode === 'vista') {
    params.set('range', $('#fRange')?.value || '24h');
  } else if (mode === 'semana') {
    params.set('range', 'semana');
  } else if (mode === 'fechas') {
    const desde = $('#expDesde')?.value;
    const hasta = $('#expHasta')?.value;
    if (!desde || !hasta) { alert('Selecciona ambas fechas.'); return; }
    params.set('desde', desde);
    params.set('hasta', hasta);
  }

  dlgExport.close();
  // Si quieres s√≥lo "mi actividad", usa /api/actividad/mia/export.csv
  window.location.href = `/api/actividad/export.csv?${params.toString()}`;
});

/* ======= Poblar dispositivos ======= */
(async function fillDevices(){
  try {
    const resp = await fetch('/api/dispositivos');
    const j = await resp.json();
    if (j.ok) {
      const sel = document.getElementById('fDevice');
      j.items.forEach(d=>{
        const o = document.createElement('option');
        o.value = d.id; o.textContent = d.nombre;
        sel.appendChild(o);
      });
    }
  } catch(_) {}
})();

/* ======= Primer pintado (SEED) y sincronizaci√≥n ======= */
(function firstPaint(){
  renderKpis(DATA);
  renderTimeline(DATA);
  refresh();
})();

// === Click en "Ver detalle" (delegado, funciona para Timeline) ===
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.btn-detalle');
  if (!btn) return;

  const id = btn.dataset.id;
  const rec = DATA.find(r => String(r.id ?? r.id_evento) === String(id));

  if (!rec) {
    console.warn('No se encontr√≥ el registro para el detalle', id);
    return;
  }
  openDetail(rec);
});
</script>

<%- include ('Plantilla/Final') %>
